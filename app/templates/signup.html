{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block title %}注册{% endblock %}
{% block content %}

    <div class="container" style="margin-top: 40px;">

        <div class="text-center">
            <h1>{{ ext_config.get('site_title', '') }} <span class="lead">考试系统</span></h1>
        </div>
    </div>

    <div class="form-center">

        <form action="{{ url_for("api.signup") }}" method="post" data-data-type="json">
            {{ form.hidden_tag() }}
            {{ wtf.form_field(form.code) }}
            {{ wtf.form_field(form.name) }}
            {{ wtf.form_field(form.password) }}
            <div class="form-group required">
                <label class="control-label" for="password2">再次输入密码</label>
                <input name="password2" id="password2" type="password" class="form-control" required value="">
            </div>

            <p class="text-info text-right">
                已注册? 点击
                <a class="text-danger" href="{{ url_for('.login_page') }}">登录</a>
            </p>
            <button type="button" class="btn btn-block btn-primary" data-type="submit">注册</button>
        </form>

    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for("static", filename="js/form.js") }}"></script>
    <script>
        $("form").form().handle({
            validators: {
                "code": $.validators.required("请填写学号"),
                "name": $.validators.required("请输入姓名"),
                "password": $.validators.required("请填写密码"),
                "password2": [
                    $.validators.required("请再次填写密码"),
                    function (field, value, info) {
                        if (info.data.password !== value) {
                            return "两次输入的密码不同"
                        }
                    }
                ]
            },

            ajax: {
                success: function (data, textStatus) {
                    console.log(textStatus, data);
                    var redirect = data.data.redirect_to;
                    if (redirect) window.location.href = redirect;
                },

                error: function (xhr, textStatus, error) {
                    console.log(textStatus, error);
                    var resp = xhr.responseJSON,
                        data = resp.data;

                    switch (resp.result_code) {

                    case resultCode.INVALID_FORM:
                        this.errors(data);
                        break;

                    case resultCode.ALREADY_REGISTERED:
                        swal({
                            title: "该学号已被注册",
                            text: "是否前往登录页登录?",
                            buttons: ["取消", "登录"],
                            icon: "warning"
                        }).then(function (value) {
                            if (value) {
                                location.href = data.redirect_to;
                            }
                        });
                        break;

                    default:  // no default

                    }
                }
            },

            error: function (errors, data) {
                console.log("form invalid", errors, data);
                this.errors(errors);
            }
        });
    </script>
{% endblock %}
